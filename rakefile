require "rom"
require "rom-sql"
require 'rom/sql/rake_task'
require_relative './lib/common'
require_relative './test/fixtures/content'

namespace :db do
  task :setup do
    APP.resolve(:rom_config)
  end

  task :seed do
    post_1 = Escritorio::Models::Post.new(
      title: "The problem with dependency injection",
      body_md: ContentFixtures.content_1,
    )

    post_2 = Escritorio::Models::Post.new(
      title: "5 less used Enumerators of Ruby",
      body_md: ContentFixtures.content_2,
    )

    APP.resolve('repos.posts').create([post_1, post_2])

    configuration = Escritorio::Models::Configuration.new({template: 'casper'})

    APP.resolve('repos.configurations').create(configuration)
  end
end

desc "Run all tests"
task :test => :"test:all"

namespace :test do
  desc "Run all tests"
  task :all do
    Dir[File.expand_path("test/**/*.rb", __dir__)].each(&Kernel.method(:require))
  end
end
